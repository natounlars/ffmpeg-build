# 给workflow写权限，否则无法上传artifacts
permissions:
  contents: read
  actions: write

name: Build Ultimate FFmpeg for Windows

on:
  workflow_dispatch:

env:
  MSYSTEM: MINGW64
  MSYS2_PATH_TYPE: inherit

jobs:
  build-ultimate:
    runs-on: windows-latest
    timeout-minutes: 240  # 包含商业功能编译需要更长时间
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    # 设置缓存，大幅缩短后续构建时间
    - name: Setup ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: ffmpeg-${{ github.event.inputs.ffmpeg_version }}
        max-size: 2G
    
    - name: Setup MSYS2 with full toolchain
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: |
          base-devel git cmake meson nasm yasm pkg-config
          mingw-w64-x86_64-toolchain mingw-w64-x86_64-cmake mingw-w64-x86_64-meson
          mingw-w64-x86_64-ccache

          
    - name: Build and install nv-codec-headers
      shell: msys2 {0}
      run: |
        git clone --depth 1 https://github.com/ffmpeg/nv-codec-headers.git
        cd nv-codec-headers
        make PREFIX=/mingw64 install

    - name: Build soxr from source
      shell: msys2 {0}
      run: |
        git clone --depth 1 https://github.com/chirlu/soxr.git
        cd soxr
        cmake -B build -G "MSYS Makefiles" \
          -DBUILD_SHARED_LIBS=OFF \
          -DCMAKE_INSTALL_PREFIX=/mingw64 \
          -DWITH_OPENMP=OFF
        cmake --build build --parallel $(nproc)
        cmake --install build

    - name: Build libsrt from source
      shell: msys2 {0}
      run: |
        git clone --depth 1 https://github.com/Haivision/srt.git
        cd srt
        cmake -B build -G "MSYS Makefiles" \
          -DBUILD_SHARED_LIBS=OFF \
          -DCMAKE_INSTALL_PREFIX=/mingw64 \
          -DENABLE_ENCRYPTION=ON \
          -DENABLE_STATIC=ON
        cmake --build build --parallel $(nproc)
        cmake --install build

        
    - name: Install prebuilt dependencies (Verified)
      shell: msys2 {0}
      run: |
        pacman -Syu --noconfirm
        pacman -S --noconfirm --needed \
          mingw-w64-x86_64-{lame,opus,libvorbis,flac,speex,twolame,wavpack} \
          mingw-w64-x86_64-{x264,x265,libvpx,libwebp,openjpeg2,xvidcore} \
          mingw-w64-x86_64-{freetype,fontconfig,fribidi,harfbuzz,libass} \
          mingw-w64-x86_64-{openssl,libssh,rtmpdump,gnutls} \
          mingw-w64-x86_64-{zlib,bzip2,lz4,zstd,lzo2} \
          mingw-w64-x86_64-{libxml2,libmodplug,rubberband,zimg,libbluray} \
          mingw-w64-x86_64-{vulkan-headers,vulkan-loader,amf-headers} \
          mingw-w64-x86_64-{libmfx,libvpl,SDL2}
    
    - name: Build missing libraries
      shell: msys2 {0}
      run: |
        # game-music-emu
        git clone --depth 1 https://github.com/libgme/game-music-emu.git
        cd game-music-emu && cmake -B build -G "MSYS Makefiles" -DBUILD_SHARED_LIBS=OFF -DCMAKE_INSTALL_PREFIX=/mingw64
        cmake --build build --parallel $(nproc) && cmake --install build && cd ..
        
        # vid.stab
        git clone --depth 1 https://github.com/georgmartius/vid.stab.git
        cd vid.stab && cmake -B build -G "MSYS Makefiles" -DBUILD_SHARED_LIBS=OFF -DCMAKE_INSTALL_PREFIX=/mingw64
        cmake --build build --parallel $(nproc) && cmake --install build && cd ..
        
        # libcaca
        git clone --depth 1 https://github.com/cacalabs/libcaca.git
        cd libcaca && ./bootstrap && ./configure --prefix=/mingw64 --disable-shared --disable-doc
        make -j$(nproc) && make install && cd ..
    
    - name: Install Rust for rav1e
      shell: msys2 {0}
      run: |
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        source ~/.cargo/env
        rustup install stable
    
    - name: Build fdk-aac (High Quality AAC)
      shell: msys2 {0}
      run: |
        git clone --depth 1 https://github.com/mstorsjo/fdk-aac.git
        cd fdk-aac && ./autogen.sh
        ./configure --prefix=/mingw64 --disable-shared --enable-static
        make -j$(nproc) && make install
    
    - name: Build dav1d (Fast AV1 Decoder)
      shell: msys2 {0}
      run: |
        git clone --depth 1 https://code.videolan.org/videolan/dav1d.git
        cd dav1d && mkdir build && cd build
        meson setup --buildtype release --default-library static --prefix=/mingw64 ..
        ninja && ninja install
    
    - name: Build SVT-AV1 (Fast AV1 Encoder)
      shell: msys2 {0}
      run: |
        git clone --depth 1 https://gitlab.com/AOMediaCodec/SVT-AV1.git
        cd SVT-AV1 && mkdir build && cd build
        cmake -G "MSYS Makefiles" -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=OFF -DCMAKE_INSTALL_PREFIX=/mingw64 ..
        make -j$(nproc) && make install
    
    - name: Build libmysofa (3D Audio Support)
      shell: msys2 {0}
      run: |
        git clone --depth 1 https://github.com/hoene/libmysofa.git
        cd libmysofa && mkdir build && cd build
        cmake -G "MSYS Makefiles" -DBUILD_SHARED_LIBS=OFF -DCMAKE_INSTALL_PREFIX=/mingw64 ..
        make -j$(nproc) && make install
    
    - name: Prepare commercial SDKs (Optional)
      shell: msys2 {0}
      run: |
        mkdir -p /opt/sdks
        cd /opt/sdks
        
        echo "=== 商业SDK准备说明 ==="
        echo "将SDK解压到/opt/sdks/目录下，例如："
        echo "- Decklink: /opt/sdks/DecklinkSDK"
        echo "- NDI: /opt/sdks/NDI SDK"
        
        mkdir -p /opt/sdks/{decklink,ndi,ipp}
    
    - name: Checkout this fork
      uses: actions/checkout@v4
      with:
         path: ffmpeg-src
         fetch-depth: 1
    
    - name: Configure FFmpeg (Ultimate Full Version)
      shell: msys2 {0}
      run: |
        cd ffmpeg-src
        
        CONFIG_OPTS="
          --prefix=/mingw64/ffmpeg-ultimate
          --arch=x86_64 --target-os=mingw32
          --enable-static --enable-shared
          --enable-gpl --enable-version3 --enable-nonfree
          --enable-pthreads --enable-w32threads
          --disable-doc --disable-ffplay
          --enable-runtime-cpudetect --enable-hardcoded-tables --enable-pic
          --enable-avisynth --enable-bzlib --enable-iconv --enable-lzma --enable-zlib
          
          --enable-libmp3lame --enable-libopus --enable-libvorbis --enable-libfdk-aac
          --enable-libsoxr --enable-libspeex --enable-libtwolame --enable-libwavpack
          --enable-libilbc --enable-libgme --enable-libmodplug --enable-libopenmpt
          --enable-libopencore-amrnb --enable-libopencore-amrwb --enable-libvo-amrwbenc
          
          --enable-libx264 --enable-libx265 --enable-libxvid --enable-libvpx
          --enable-libwebp --enable-libopenjpeg --enable-libdav1d
          
          --enable-libfreetype --enable-libfontconfig --enable-libfribidi
          --enable-libharfbuzz --enable-libass
          
          --enable-filters --enable-avresample --enable-swresample --enable-postproc
          --enable-librubberband --enable-libvidstab --enable-libzimg
          --enable-libbs2b --enable-libcaca --enable-libzvbi
          
          --enable-libbluray --enable-libxml2 --enable-libssh --enable-libsrt
          --enable-librtmp --enable-openssl --enable-gnutls
          
          --enable-dxva2 --enable-d3d11va --enable-cuda --enable-cuda-llvm
          --enable-cuvid --enable-nvenc --enable-nvdec --enable-vulkan
          --enable-libmfx --enable-libvpl  # Intel QSV/VPL
          --enable-amf --enable-opencl     # AMD AMF / OpenCL
          
          --enable-asm --enable-inline-asm --enable-x86asm
          --extra-cflags='-I/mingw64/include -O3 -mtune=native'
          --extra-ldflags='-L/mingw64/lib -static-libgcc'
          --pkg-config-flags='--static'
        "
        
        if [ "${{ github.event.inputs.build_type }}" = "ultimate" ]; then
          COMMERCIAL_OPTS="
            --enable-decklink 
            --enable-libndi_newtek 
            --enable-libismv 
          "
          CONFIG_OPTS="$CONFIG_OPTS $COMMERCIAL_OPTS"
          echo "警告：商业功能已启用，需确保SDK已正确放置"
        fi
        
        echo "配置选项：$CONFIG_OPTS"
        ./configure $CONFIG_OPTS || {
          echo "=== 配置失败分析 ==="
          tail -n 50 ffbuild/config.log
          exit 1
        }
    
    - name: Build FFmpeg with ccache
      shell: msys2 {0}
      run: |
        cd ffmpeg-src
        export CC="ccache gcc"
        export CXX="ccache g++"
        make -j$(nproc) 2>&1 | tee build.log
        ccache -s 
        make install
    
    - name: Verify ultimate build
      shell: msys2 {0}
      run: |
        cd /mingw64/ffmpeg-ultimate/bin
        echo "=== FFmpeg 构建配置 ==="
        ./ffmpeg.exe -buildconf
        
        echo "=== 关键编解码器验证 ==="
        ./ffmpeg.exe -codecs | grep -E "DEV|DEA" | grep -E "h264|hevc|av1|vp9|aac" | head -20
        
        echo "=== 硬件加速验证 ==="
        ./ffmpeg.exe -hwaccels
        
        echo "=== 协议支持 ==="
        ./ffmpeg.exe -protocols | grep -E "https|rtmp|srt"
    
    - name: Create portable archive
      shell: msys2 {0}
      run: |
        cd /mingw64/ffmpeg-ultimate
        ldd bin/ffmpeg.exe | grep '/mingw64/bin' | awk '{print $3}' | xargs -I{} cp {} bin/
        7z a -mx9 ffmpeg-ultimate-${{ github.event.inputs.ffmpeg_version }}-${{ github.event.inputs.build_type }}.7z *
    
    - name: Upload ultimate artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ffmpeg-ultimate-${{ github.event.inputs.ffmpeg_version }}
        path: /mingw64/ffmpeg-ultimate/*.7z
        retention-days: 90
